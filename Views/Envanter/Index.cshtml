@model IEnumerable<BLBM_ENV.Models.Envanter>

@{
    ViewData["Title"] = "Envanter Listesi";
}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @Html.Raw(TempData["SuccessMessage"])
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @Html.Raw(TempData["ErrorMessage"])
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["InfoMessage"] != null)
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        @Html.Raw(TempData["InfoMessage"])
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="card shadow-sm">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">@ViewData["Title"]</h4>
            <div class="btn-group">
                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#virtualDetailImportModal">
                    <i class="fas fa-cloud-upload-alt me-1"></i> Sanal Port Detayı Yükle
                </button>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#excelImportModal">
                    <i class="fas fa-file-excel me-1"></i> Envanter Yükle
                </button>
                <a asp-controller="Envanter" asp-action="Create" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i> Yeni Cihaz Ekle
                </a>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="envanterTablosu" class="table table-striped table-bordered table-sm" style="width:100%">
                <thead>
                    <tr>
                        <th>Cihaz Adı</th>
                        <th>Tür</th>
                        <th>Model</th>
                        <th>Servis Etiketi / Seri No</th>
                        <th>Yönetim IP</th>
                        <th>ILO/iDRAC IP</th>
                        <th>VCenter</th>
                        <th>Küme</th>
                        <th>İşletim Sistemi</th>
                        <th>Lokasyon</th>
                        <th>Kabin</th>
                        <th>Ön/Arka</th>
                        <th>U Değeri</th>
                        <th class="text-center no-filter">Bağlantılar</th>
                        <th class="text-center no-sort no-filter">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td><strong>@item.DeviceName</strong></td>
                                <td>@item.Tur</td>
                                <td>@item.Model</td>
                                <td><code>@item.ServiceTagSerialNumber</code></td>
                                <td><code>@item.IpAddress</code></td>
                                <td><code>@item.IloIdracIp</code></td>
                                <td>@item.VcenterAddress</td>
                                <td>@item.ClusterName</td>
                                <td>@item.OperatingSystem</td>
                                <td>@item.Location</td>
                                <td>@item.Kabin</td>
                                <td>@item.RearFront</td>
                                <td>@item.KabinU</td>
                                <td class="text-center">
                                    <span class="badge bg-dark rounded-pill">@(item.AsSourceConnections.Count() + item.AsTargetConnections.Count())</span>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm">
                                        <a asp-controller="Envanter" asp-action="Details" asp-route-id="@item.ID" class="btn btn-outline-info" title="Detayları Görüntüle"><i class="fas fa-eye"></i></a>
                                        <a asp-controller="Envanter" asp-action="Edit" asp-route-id="@item.ID" class="btn btn-outline-warning" title="Düzenle"><i class="fas fa-pencil-alt"></i></a>
                                        <a asp-controller="Envanter" asp-action="Delete" asp-route-id="@item.ID" class="btn btn-outline-danger" title="Sil"><i class="fas fa-trash-alt"></i></a>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="excelImportModal" tabindex="-1" aria-labelledby="excelImportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-controller="Envanter" asp-action="ImportFromExcel" method="post" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title" id="excelImportModalLabel">Excel'den Envanter Yükle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="excelFile" class="form-label">Excel Dosyası (.xlsx)</label>
                        <input class="form-control" type="file" name="excelFile" id="excelFile" accept=".xlsx" required>
                    </div>
                    <hr />
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="deleteAll" value="true" id="deleteAllSwitch">
                        <label class="form-check-label fw-bold" for="deleteAllSwitch">Mevcut Kayıtları Sil ve Yükle</label>
                    </div>
                    <div class="alert alert-danger mt-2" role="alert">
                        <strong>Dikkat:</strong> Bu seçeneği işaretlerseniz, yükleme yapmadan önce veritabanındaki <strong>tüm envanter ve bağlantı kayıtları kalıcı olarak silinecektir!</strong>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-upload me-1"></i> Yükle</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="virtualDetailImportModal" tabindex="-1" aria-labelledby="virtualDetailImportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-controller="EnvanterDetail" asp-action="ImportVirtualFromExcel" method="post" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title" id="virtualDetailImportModalLabel">Excel ile Sanal Port Detayı Yükle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="excelFile" class="form-label">Excel Dosyası (.xlsx)</label>
                        <input class="form-control" type="file" name="excelFile" id="excelFile" accept=".xlsx" required>
                    </div>
                    <div class="alert alert-info" role="alert">
                        <strong>Bilgi:</strong> Bu işlem, Excel dosyasındaki `Türü` sütunu "Virtual" ile başlayan satırları okuyarak ilgili cihazlara port detayı olarak ekleyecektir.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-upload me-1"></i> Yükle</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        $(document).ready(function () {
             $('body').append('<div class="dt-filter-dropdown" style="display:none;"></div>');
            var dropdown = $('.dt-filter-dropdown');

            var table = $('#envanterTablosu').DataTable({
                ordering: false,
                paging: false,
                lengthChange: false,
                info: false,
                language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json' },
                columnDefs: [{
                    targets: '_all',
                    render: function (data, type, row) {
                        if (type === 'filter' || type === 'sort') {
                            if (typeof data === 'string') {
                                return data.replace(/<[^>]*>/g, '').trim();
                            }
                            return data;
                        }
                        return data;
                    }
                }],
                initComplete: function () {
                    this.api().columns().every(function () {
                        var column = this;
                        var header = $(column.header());
                        if (header.hasClass('no-filter') || header.hasClass('no-sort')) return;
                        header.append('<i class="fas fa-filter filter-icon"></i>');
                    });
                }
            });

            $('#envanterTablosu thead').on('click', '.filter-icon', function (e) {
                e.stopPropagation();
                var icon = $(this);
                var header = icon.parent();
                var columnIndex = header.index();
                var column = table.column(columnIndex);
                var currentSearch = column.search();

                var content = `<input type="text" class="form-control form-control-sm mb-2 dropdown-search" placeholder="Seçeneklerde ara..."><div class="d-flex justify-content-between mb-2"><button class="btn btn-sm btn-outline-primary select-all">Tümünü Seç</button><button class="btn btn-sm btn-outline-secondary clear-filter">Filtreyi Temizle</button></div><div class="dt-filter-list"></div>`;
                dropdown.html(content).data('columnIndex', columnIndex);

                var uniqueValues = [];
                column.nodes().each(function (node) {
                    var cellText = $(node).text().trim();
                    if (cellText && uniqueValues.indexOf(cellText) === -1) {
                        uniqueValues.push(cellText);
                    }
                });
                uniqueValues.sort();

                var searchTerms = currentSearch ? currentSearch.replace(/(^\^|\$$)/g, '').split('|') : [];

                $.each(uniqueValues, function (j, value) {
                    var isChecked = !currentSearch || searchTerms.includes(value.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'));
                    dropdown.find('.dt-filter-list').append(`<div class="form-check dt-filter-item"><input class="form-check-input filter-checkbox" type="checkbox" value="${value}" ${isChecked ? 'checked' : ''}><label class="form-check-label">${value}</label></div>`);
                });

                var pos = icon.offset();
                var dropdownWidth = dropdown.outerWidth();
                var windowWidth = $(window).width();
                var proposedLeft = pos.left - dropdownWidth + icon.outerWidth();

                if (proposedLeft + dropdownWidth > windowWidth) { proposedLeft = windowWidth - dropdownWidth - 15; }
                if (proposedLeft < 0) { proposedLeft = 15; }

                dropdown.css({ top: pos.top + icon.outerHeight(), left: proposedLeft, display: 'block' });
            });

            $(document).on('click', '.select-all', function() { $(this).closest('.dt-filter-dropdown').find('.filter-checkbox:visible').prop('checked', true).trigger('change'); });
            $(document).on('click', '.clear-filter', function() { $(this).closest('.dt-filter-dropdown').find('.filter-checkbox').prop('checked', false).trigger('change'); });

            $(document).on('change', '.filter-checkbox', function () {
                var dropdown = $(this).closest('.dt-filter-dropdown');
                var columnIndex = dropdown.data('columnIndex');
                var column = table.column(columnIndex);
                var checkedValues = [];
                dropdown.find('.filter-checkbox:checked').each(function() { checkedValues.push($(this).val()); });

                if(checkedValues.length === 0 || checkedValues.length === uniqueValues.length) {
                    column.search('').draw();
                } else {
                     var regex = '^(' + checkedValues.map(v => v.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')).join('|') + ')$';
                     column.search(regex, true, false).draw();
                }

                var icon = $(column.header()).find('.filter-icon');
                icon.toggleClass('active', !!column.search());
            });

            $(document).on('keyup', '.dropdown-search', function() {
                var searchTerm = $(this).val().toLowerCase();
                $(this).closest('.dt-filter-dropdown').find('.dt-filter-item').each(function() { $(this).toggle($(this).find('label').text().toLowerCase().includes(searchTerm)); });
            });

            $(document).on('click', function (e) {
                if (!$(e.target).closest('.dt-filter-dropdown, .filter-icon').length) {
                    $('.dt-filter-dropdown').hide();
                }
            });
        });
    </script>
}